name: Security - SBOM & SCA

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "requirements*.txt"
      - "pyproject.toml"
      - "Dockerfile"
      - ".github/workflows/ci-sbom-sca.yml"
  pull_request:
    paths:
      - "**/*.py"
      - "requirements*.txt"
      - "pyproject.toml"
      - "Dockerfile"
      - ".github/workflows/ci-sbom-sca.yml"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sbom_sca:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure evidence dirs
        run: mkdir -p EVIDENCE/P09

      - name: Generate SBOM (Syft -> CycloneDX)
        run: |
          set -euo pipefail
          docker run --rm -v "$PWD:/work" -w /work anchore/syft:latest             packages dir:. -o cyclonedx-json > EVIDENCE/P09/sbom.json

      - name: SCA scan (Grype) + summary
        run: |
          set -euo pipefail
          docker run --rm -v "$PWD:/work" -w /work anchore/grype:latest             sbom:/work/EVIDENCE/P09/sbom.json -o json > EVIDENCE/P09/sca_report.json

          {
            echo "# SCA summary"
            echo
            echo "Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            echo
            echo "## Counts by severity"
            echo
          } > EVIDENCE/P09/sca_summary.md

          # jq exists on ubuntu-latest; keep workflow green even if report has no matches
          jq -r '
            if (.matches // []) | length == 0 then
              {"Critical":0,"High":0,"Medium":0,"Low":0,"Unknown":0}
            else
              ([.matches[].vulnerability.severity] |
                map(. // "Unknown") |
                map(if .=="Negligible" then "Low" else . end) |
                group_by(.) |
                map({(.[0]): length}) |
                add
              ) as $m |
              {"Critical":($m.Critical//0),
               "High":($m.High//0),
               "Medium":($m.Medium//0),
               "Low":($m.Low//0),
               "Unknown":($m.Unknown//0)}
            end
          ' EVIDENCE/P09/sca_report.json           | jq -r 'to_entries | sort_by(.key) | map("- **\(.key)**: \(.value)") | .[]'           >> EVIDENCE/P09/sca_summary.md || true

          {
            echo
            echo "## Notes"
            echo
            echo "- Report: \`EVIDENCE/P09/sca_report.json\`"
            echo "- SBOM: \`EVIDENCE/P09/sbom.json\`"
            echo "- Next: triage High/Critical â†’ update deps or add time-limited waiver in \`policy/waivers.yml\`."
          } >> EVIDENCE/P09/sca_summary.md

      - name: Upload SBOM/SCA evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: P09_EVIDENCE
          path: EVIDENCE/P09
