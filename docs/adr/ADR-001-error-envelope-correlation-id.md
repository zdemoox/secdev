# ADR-001: Единый error-envelope + correlation_id для всех ошибок API
Дата: 2025-12-14
Статус: Accepted

## Context
Study Planner предоставляет HTTP API. Для безопасной эксплуатации нам нужны:
- единый формат ошибок без утечек внутренних деталей;
- корреляция запросов для расследований (audit/debug);
- воспроизводимая проверка через тесты и CI.

В Threat Model (P04) риск **R4 (утечка деталей ошибок)** и **R3 (недостаточная трассируемость)** связаны с потоками F1/F5/F6.

## Decision
- Все ошибки (включая `HTTPException` и доменные ошибки) возвращаем в едином JSON error-envelope:
  `{"error": {"code": "...", "message": "...", "correlation_id": "..."}}`
- Корреляционный идентификатор берём из заголовка `X-Request-Id` (если задан клиентом/edge), иначе генерируем UUID.
- `X-Request-Id` возвращаем в ответе, чтобы клиент мог сопоставлять запрос/ответ.

## Alternatives
1. **RFC7807 (Problem Details)** полностью:
   - (+) стандартный формат, хорош для интеграций
   - (−) потребует миграции контрактов/клиентов и тестов
2. **Логировать только на сервере без возврата correlation_id**:
   - (+) проще
   - (−) хуже DX/поддержка, сложнее расследовать инциденты
3. **Принимать correlation_id только от gateway**:
   - (+) единый источник
   - (−) усложняет локальную разработку и тестирование

## Consequences
Плюсы:
- упрощается контракт ошибок и обработка на клиенте;
- проще triage/инциденты (везде есть correlation_id).

Минусы/компромиссы:
- correlation_id становится частью внешнего контракта (нужно поддерживать обратную совместимость).

## Security impact
- Снижаем риск **R4** (уменьшаем вероятность утечки внутренних деталей).
- Улучшаем расследуемость (частично закрываем **R3**).
- Уменьшаем шанс попадания чувствительных данных в error message (политика маскирования).

## Rollout plan
1. Включить middleware корреляции и общий обработчик ошибок.
2. Добавить контрактные тесты на наличие `correlation_id` и заголовка `X-Request-Id`.
3. Обновить документацию API при появлении клиентов.

## Links
- NFR-02 (Единый формат ошибок без утечек), NFR-05 (Логи и корреляция)
- Threat Model: F1/F5/F6, риски R3/R4
- Реализация: `app/main.py` (middleware + handlers)
- Тесты: `tests/test_errors.py::test_error_has_correlation_id_and_header`, `tests/test_errors.py::test_respects_client_provided_request_id`
